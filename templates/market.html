{% extends "layout.html" %}
{% block title %}MARKET{% end %}
{% block content %}
		
		<h1>MARKET</h1>
				
		<div id="sockettest">
			<h3 id="marketItem"></h3>
			<table class="table table-striped">
				<thead><tr><th>Data</th></tr></thead>
				<tbody id="marketTable">
				{% for d in sorted(data, key=lambda d:d['price'] )%}
				<tr id={{d['location_id']}}>
					<td>{{d['location_name']}}</td>
					<td>{{d['price']}}</td>
					<td>{{d['volume_remain']}} / {{d['volume_total']}}</td>
				</tr>
				{% end %}
				</tbody>
			</table>
		</div>

		<script type="text/javascript">

			var data = [];
			var connection = '';

			function openSocket(){

				var host = location.origin.replace('http','ws') + '/ws/test'

				connection = new WebSocket(host);
				
				var status = $('#socketStatus');

				connection.onopen = function (event) {
					status.html('<p>CONNECTION OPEN</p>');
				};

				connection.onclose = function (event) {
					status.html('<p>CONNECTION CLOSED</p>');
					setTimeout(openSocket, 2000);
				};

				connection.onerror = function (event) {
					status.html('<p>ERROR</p>');
				};

				connection.onmessage = function (event) {
					
					data = JSON.parse(event.data).inbound;
					update(data);
				};
			}

			function update(updateData){
				

			}

			$(document).ready(function(){

				var tr = d3.selectAll("tr");

				tr.on("click" , function(d){ 
					connection.send(JSON.stringify({'w':this.id}));
					});

				openSocket();

			});

		</script>

{% end %}